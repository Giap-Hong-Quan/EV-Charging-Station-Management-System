version: "3.9"

services:
  # üóÑÔ∏è MySQL Database
  user_mysql:
    image: mysql:8.0
    container_name: user_mysql
    restart: always
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: "123456"
      MYSQL_DATABASE: "user_db"
    volumes:
      - user_data:/var/lib/mysql
    networks:
      - evcs_network
    healthcheck:  # ‚¨ÖÔ∏è TH√äM HEALTHCHECK
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p123456"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s

  # üë• User Service
  user_service:
    build: ./User_Service
    container_name: user_service
    ports:
      - "8082:8082"
    environment:
      NODE_ENV: development
      PORT: 8082
      DB_HOST: user_mysql
      DB_PORT: 3306
      DB_NAME: user_db
      DB_USER: root
      DB_PASSWORD: "123456"
      JWT_SECRET: supersecret_12345
      URL_REACT: http://localhost:5173
      CLOUDINARY_CLOUD_NAME: dqggvzehq
      CLOUDINARY_API_KEY: 819234615681677
      CLOUDINARY_API_SECRET: 6m5_aZkgnnABQR85Rt4t910sFJw
    depends_on:
      user_mysql:
        condition: service_healthy  # ‚¨ÖÔ∏è ƒê√É C√ì HEALTHCHECK ·ªû TR√äN
    volumes:
      - ./User_Service:/app
      - /app/node_modules
    command: npm run dev 
    restart: unless-stopped
    networks:
      - evcs_network

  # üìä Analytics MongoDB
  analytics_mongo:
    image: mongo:6
    container_name: analytics_mongo
    restart: always
    ports:
      - "27018:27017"
    volumes:
      - analytics_data:/data/db
    networks:
      - evcs_network

  # üìä Analytics Reporting Service
  analytics_reporting_service:
    build: ./Analytics_Reporting_Service
    container_name: analytics_reporting_service
    ports:
      - "5002:5002"
    env_file:
      - ./Analytics_Reporting_Service/.env
    depends_on:
      - analytics_mongo
    volumes:
      - ./Analytics_Reporting_Service:/app
      - /app/node_modules
    command: npm run dev
    restart: unless-stopped
    networks:
      - evcs_network

  # ‚ö° Station MongoDB
  station_mongo:
    image: mongo:6
    container_name: station_mongo
    restart: always
    ports:
      - "27017:27017"
    volumes:
      - station_data:/data/db
    networks:
      - evcs_network

  # ‚ö° Station Management Service
  station_management_service:
    build: ./Station_Management_Service
    container_name: station_management_service
    ports:
      - "5001:5001"
    env_file:
      - ./Station_Management_Service/.env
    depends_on:
      - station_mongo
    volumes:
      - ./Station_Management_Service:/app
      - /app/node_modules
    command: npm run dev
    restart: unless-stopped
    networks:
      - evcs_network

  # üöó Booking MySQL
  # booking_mysql:
  #   image: mysql:8.0
  #   container_name: booking_mysql
  #   restart: always
  #   environment:
  #     MYSQL_ROOT_PASSWORD: 292902
  #     MYSQL_DATABASE: booking_db
  #   ports:
  #     - "3307:3306"
  #   volumes:
  #     - booking_mysql_data:/var/lib/mysql
  #   networks:
  #     - evcs_network

  # # üöó Booking Service
  # booking_service:
  #   build:
  #     context: ./booking_service
  #   container_name: booking_service
  #   restart: always
  #   ports:
  #     - "5000:5000"
  #   environment:
  #     MYSQL_HOST: booking_mysql
  #     MYSQL_USER: root
  #     MYSQL_PASSWORD: 292902
  #     MYSQL_DB: booking_db
  #     PORT: 5000
  #   depends_on:
  #     - booking_mysql
  #   networks:
  #     - evcs_network

  # üåê API Gateway
  # gateway:
  #   build: ./gateway
  #   container_name: gateway
  #   restart: always
  #   ports:
  #     - "8000:8000"
  #   depends_on:
  #     - user_service
  #     - station_management_service
  #     - booking_service
  #     - analytics_reporting_service
  #   volumes:
  #     - ./gateway:/app
  #     - /app/node_modules
  #   working_dir: /app
  #   command: npm start
  #   networks:
  #     - evcs_network

volumes:
  user_data:
  analytics_data:
  station_data:
  # booking_mysql_data:

networks:
  evcs_network:
    driver: bridge
